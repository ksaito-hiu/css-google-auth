<h1>Create account</h1>

<p class="error" id="error"></p>

<fieldset>
  <legend>
    <a id="link-to-google" href="">Please click this link to be authenticated by Google.</a>
  </legend>
</fieldset>

<ul class="actions">
  <li><a id="google-login-link" href="" class="link">restart google login</a></li>
</ul>

<script>
  (async() => {
    let controls = await fetchControls('<%= idpIndex %>');

    document.querySelector('#google-login-link').setAttribute('href',controls.html.google.login);

    const queryStr = window.location.search.slice(1);
    const queries = {};
    if (queryStr) {
      queryStr.split('&').forEach((kv)=>{
        const [k,v] = kv.split('=');
        queries[k] = v;
      });
    }
    if (queries['scope']) {
      // クエリ文字列にscopeがあったらoidc-google.html.ejsからリダイレクトされて来た時と見なす
      document.querySelector('#link-to-google').style.display = "none";
      try {
        // controls.account.create,controls.google.create,controls.google.loginの3つの
        // を合体させた処理をcontrols.google.registerに作らないといけない。
        const res = await postJson(controls.google.register,{ url: window.location.href });
        const json = await res.json();
console.log("GAHA2: json=",json);
        if (json.authorization) { // たぶん成功
          controls = await fetchControls('<%= idpIndex %>');
console.log("GAHA3: Logged in! a=",controls.html.account.account);
          window.location.href = controls.html.account.account;
        } else {
console.log("GAHA4: Not logged in!");
          document.querySelector('#error').textContent = json.message;
        }
      } catch(err) {
console.log("GAHA5: ",err);
        document.querySelector('#error').textContent = "Error:";
      }
    } else {
      // それ以外は、ログイン前の状態と見なす
      document.querySelector('#google-login-link').style.display = "none";
      const res = await postJson(controls.google.oidc,{func:'makeUrl',stage:'register'});
      const { response } = await res.json();
      document.querySelector('#link-to-google').setAttribute('href',response);
    }
  })();
</script>
